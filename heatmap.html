<html>
    <!DOCTYPE html>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <head>
                
    <!-- Load d3.js -->
    <!-- <script src="libs/d3.v6.js"></script>
    <script src="libs/moment.js"></script>
    <script src="libs/hammer.min.js"></script>
    <script src="libs/jquery-3.6.0-min.js"></script> -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="utils/logger.css">
    <!--<link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,100;1,400;1,500;1,700&display=swap" rel="stylesheet"> -->
    </head>

    <body><!-- onload="init();"-->
        <!-- Create a div where the graph will take place -->
        <div id="my_dataviz"></div>
        <div id="tile-details"></div>

        <!--<div id="target">
            Touch and Hold with 2 pointers, then pinch in or out.<br />
            The background color will change to pink if the pinch is opening (Zoom In)
            or changes to lightblue if the pinch is closing (Zoom out).
        </div>-->

        <div id="target-hammer">
            Touch and Hold with 2 pointers, then pinch in or out.<br />
            The background color will change to pink if the pinch is opening (Zoom In)
            or changes to lightblue if the pinch is closing (Zoom out).
        </div>

        <div id="log"></div>
        <!--<script src="heatmap_static.js"></script>-->
        <!--<script src="utils/pinch.js"></script>-->
        <!-- <script src="utils/logger.js"></script>
        <script src="heatmap_scroll.js"></script>
        <script src="utils/hammer-pinch.js"></script> -->
        <script>
            var modules = [
            `https://cdnjs.cloudflare.com/ajax/libs/d3/7.6.1/d3.min.js`,
            `https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js`
            ]

            Date.prototype.getWeek = function () {
                var target  = new Date(this.valueOf());
                var dayNr   = (this.getDay() + 6) % 7;
                target.setDate(target.getDate() - dayNr + 3);
                var firstThursday = target.valueOf();
                target.setMonth(0, 1);
                if (target.getDay() != 4) {
                    target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
                }
                return 1 + Math.ceil((firstThursday - target) / 604800000);
            }
            

            Date.prototype.getWeekDay = function(format='') {
                const weekday = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
                var isSunday = this.getDay()-1

                if(isSunday < 0){
                    console.warn(`${this.toDateString()} is a Sunday: ${isSunday}, week ${weekday[6]}`)
                }
                isSunday = isSunday < 0 ? 6 : isSunday
                day = weekday[isSunday]

                return format.length === 0 ? day : day.substring(0, format.length);
            }

            Date.prototype.isBefore = function(date) {
                var current = this.getTime()
                var other = date.getTime()

                return current < other
            }

            Promise.all(
                modules.map((module, _) =>
                    import(module)
                )
            ).then(() => {
                console.log(`modules loaded!`)
                var viewportwidth = window.innerWidth
                || document.documentElement.clientWidth
                || document.body.clientWidth;

                var height = (window.innerHeight
                || document.documentElement.clientHeight
                || document.body.clientHeight)/2;

                var gridsize = 32
                var fontsizeaxis = 11

                var //width = 800,
                    //height = 400,
                    margintop = 24,
                    marginbottom = 8,
                    marginright = 32,
                    marginleft = 40

                var oldData
                d3.csv("data/steps.csv").then(function (data) {
                    console.log(`creation_time: ${new Date(data[0].create_time)}`)
                    data.sort((a, b) => new Date(a.create_time).isBefore(new Date(b.create_time)))
                    //console.log(data.filter(d => d.create_time))
                    const myGroups = Array.from(new Set(data.map(d => new Date(d.create_time).getWeek()))).sort((a,b) => a > b)
	                const myVars = Array.from(new Set(data.map(d => new Date(d.create_time))))/*.sort((a,b) => b.getDay() > a.getDay())*/.map(d => d.getWeekDay('ddd'))
                    console.log(myVars)


                    height = gridsize*7
                    var width = myGroups.length > 1 ? (myGroups[myGroups.length-1] - myGroups[0])*gridsize : gridsize

                    var svg = d3.select("#my_dataviz")
                        .append("div")
                        // Note the CSS rules for .chart
                        .attr("class", "chart")
                        //.style("max-width", width)
                        .append("svg")
                        .attr("width", width + marginleft + marginright)
                        // No margin-top required here, because the other element already took care of it
                        .attr("height", height + margintop + marginbottom)
                        .append("g")
                        // Same, no margin-top
                        .attr("transform", `translate(${marginleft}, 0)`);

                    // Add title to graph
                    d3.select("#my_dataviz")
                        .append("text")
                        .attr("x", viewportwidth/2)
                        .attr("y", height + margintop + marginbottom)
                        .attr("class", "y-axis-title")
                        .style("max-width", viewportwidth)
                        .style("margin-left", marginleft)
                        .text("week");

                    // Use the gradient to set the shape fill, via CSS.
                    var axis = d3.select("#my_dataviz")
                        .append("svg")
                        .attr("class", "y-axis")
                        .attr('width', marginleft)
                        .attr('height', height + margintop + marginbottom)
                        .style("top", marginbottom + 1)

                    var mainGradient = axis.append('defs')
                        .append('linearGradient')
                        .attr('id', 'mainGradient')
                    
                    mainGradient.append('stop')
                        .attr('class', 'stop-left')
                        .attr('offset', '0.9')

                    mainGradient.append('stop')
                        .attr('class', 'stop-right')
                        .attr('offset', '1')

                    axis.append("rect")
                        .classed('filled', true)
                        .attr('width', marginleft)
                        .attr('height', height + margintop + marginbottom)
                        
                    axis = axis.append("g")
                        .attr("transform", `translate(${marginleft}, 0)`)
                        .on("click", function (d) {
                            console.log(`X clicked`)
                        })

                    var x_axis = d3.scaleBand()
                        .range([0, width])
                        .domain(myGroups)
                        .padding(0.05);

                    svg.append("g")
                        .style("font-size", fontsizeaxis)
                        .attr("transform", `translate(0, ${height})`)
                        .call(d3.axisBottom(x_axis).tickSize(0).tickPadding([16]))
                        .attr("class", "x_axis")
                        .select(".domain").remove()
                        .selectAll("text")
                        .on("wheel.zoom", function(event, d){
                            event.preventDefault()
                            console.log("wheeled")
                        })

                    // axis.call(d3.axisBottom(x_axis).tickSize(0).tickPadding([16]))
                    // 	.selectAll("text")
                    // 	.style("text-anchor", "end")
                    // 	.style("position", "fixed")
                    // 	.attr("dx", 15)
                    // 	.attr("dy", 5)
                    // 	.attr("transform", "rotate(-65)");

                    var y_axis = d3.scaleBand()
                        .range([height, 0])
                        .domain(myVars)
                        .padding(0.05);

                    axis.call(d3.axisLeft(y_axis).tickSize(0).tickPadding([16]))
                        .style("font-size", fontsizeaxis)
                        .select(".domain").remove()
                        .selectAll("text")
                        //.style("text-anchor", "end")
                        .style("position", "fixed")
                        .attr("transform", function(d,i){
                            return "rotate(-90 " + (50 + 80*i) + " 50)";
                        })

                    var myColor = d3.scaleSequential()
                        .interpolator(d3.interpolateInferno)
                        .domain([30000, 100])

                    // create a tooltip
                    const tooltip = d3.select("#tile-details")
                    .append("div")
                    .style("opacity", 0)
                    .attr("class", "tooltip")
                    .style("background-color", "white")
                    .style("border", "solid")
                    .style("border-width", "2px")
                    .style("border-radius", "5px")
                    .style("padding", "5px")

                    // Three function that change the tooltip when user hover / move / leave a cell
                    const mouseover = function(event,d) {
                        tooltip
                            .style("opacity", 1)
                        d3.select(this)
                            .style("stroke", "#333")
                            .style("opacity", 1)
                    }
                    const mousemove = function(event,d) {
                        tooltip
                            .html(`${new Date(d.create_time).toString()} steps: ${d.count}`)
                            .style("left", (event.x)/2 + "px")
                            .style("top", (event.y)/2 + "px")
                    }
                    const mouseleave = function(event,d) {
                        tooltip
                            .style("opacity", 0)
                        d3.select(this)
                            .style("stroke", "none")
                            .style("opacity", 0.8)
                    }

                    const tapsquare = function(event, d) {
                        if(this === oldData){
                            oldData = null
                            tooltip
                                .style("opacity", 0)
                            d3.select(this)
                                .style("stroke", "none")
                                .style("opacity", 0.8)
                            console.log(`square deselected`)
                        }else{
                            if(oldData !== null){
                                tooltip
                                    .style("opacity", 0)
                                d3.select(oldData)
                                    .style("stroke", "none")
                                    .style("opacity", 0.8)
                                console.log(`deselecting old`)
                            }
                            tooltip
                                .html(`${new Date(d.create_time).toString()}, steps: ${d.count}`)
                                .style("left", (event.x)/2 + "px")
                                .style("top", (event.y)/2 + "px")

                            tooltip
                                .style("opacity", 1)
                            d3.select(this)
                                .style("stroke", "#333")
                            .style("opacity", 1)
                            console.log(`selected square`)
                            oldData = this
                        }
                    }

                    svg.selectAll()
                    .data(data, function (d) {
                        return new Date(d.create_time).getWeek()+':'+new Date(d.create_time).getWeekDay('ddd');
                    })
                    .join("rect")
                    /*.enter()
                    .append("rect")*/
                    .attr("x", function (d) {
                        return x_axis(new Date(d.create_time).getWeek())
                    })
                    .attr("y", function (d) {
                        return y_axis(new Date(d.create_time).getWeekDay('ddd'))
                    })
                    .attr("rx", 4)
                    .attr("ry", 4)
                    .attr("width", x_axis.bandwidth())
                    .attr("height", y_axis.bandwidth())
                    .style("fill", function (d) {
                        return myColor(d.count)
                    })
                    .style("stroke-width", 4)
                    .style("stroke", "none")
                    .style("opacity", 0.8)
                    .on("mouseover", mouseover)
                    .on("mousemove", mousemove)
                    .on("mouseleave", mouseleave)
                    .on("click", tapsquare)
                })
            })
        </script>
    </body>
</html>